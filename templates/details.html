
<!-- details.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ property.title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/details.css') }}">
  <style>
    #flyer-frame { display: none; }
  </style>
</head>
<body>
  <!-- Hidden Iframe for Printing Flyer -->
  <iframe id="flyer-frame" style="display: none;"></iframe>

  <!-- CAROUSEL -->
  <section class="carousel-container">
    <div class="slides">
      {% if property.images %}
        <!-- Duplicated last slide -->
        <div class="slide">
          <img
            src="{{ url_for('static', filename='images/' ~ property.images[-1]) }}"
            alt="Photo {{ property.images|length }}"
          >
        </div>
        <!-- Real slides -->
        {% for img in property.images %}
          <div class="slide">
            <img
              src="{{ url_for('static', filename='images/' ~ img) }}"
              alt="Photo {{ loop.index }}"
            >
          </div>
        {% endfor %}
        <!-- Duplicated first slide -->
        <div class="slide">
          <img
            src="{{ url_for('static', filename='images/' ~ property.images[0]) }}"
            alt="Photo 1"
          >
        </div>
      {% else %}
        <div class="slide">
          <img
            src="{{ url_for('static', filename='images/placeholder.jpg') }}"
            alt="No image"
          >
        </div>
      {% endif %}
    </div>
    <button class="nav prev" aria-label="Previous slide">❮</button>
    <button class="nav next" aria-label="Next slide">❯</button>

    <div class="caption">
      <div class="info">
        <p><strong>{{ property.address }}</strong></p>
        <p>{{ property.title }}</p>
        <p>{{ property.type }} | {{ property.status }} • {{ property.size }} SF</p>
      </div>
      <button class="print-btn" onclick="printFlyer('{{ property.id }}')">Print</button>
    </div>
  </section>

  <!-- DETAILS & CONTACT PANEL -->
  <section class="property-info-section">
    <div class="property-info-container">
      <div class="property-details">
        <h1>Property Details</h1>
        <h3 class="status">{{ property.status|upper }}</h3>
        <p class="price">
          <strong>{{ property.price }}$</strong>
          <span>{% if property.status == 'For Lease' %}/month{% endif %}</span>
        </p>
        <p class="description">{{ property.description }}</p>
        <hr>
        <h3>Features</h3>
        <ul>
          {% for feat in property.features %}
            <li>{{ feat }}</li>
          {% endfor %}
        </ul>
        <hr>
        <h3>Location</h3>
        <a href="{{ property.location }}" target="_blank" class="map-button">
          Open Map
        </a>
        <div class="map-container">
          {% if property.location %}
            <iframe
              src="{{ property.location | to_embed_url }}"
              width="100%"
              height="300"
              style="border:0; border-radius: 10px; margin-top: 15px;"
              allowfullscreen=""
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade">
            </iframe>
          {% else %}
            <p>Map unavailable</p>
          {% endif %}
        </div>
      </div>

      <div class="expert-card">
        <h3>Get More Info</h3>
        <p class="description">Learn more about this listing by contacting our expert.</p>
        <div class="expert-info">
          <h4>Jennifer Tavares</h4>
          <p class="title"><strong>Agent</strong></p>
          <p class="location">Winnipeg, Manitoba</p>
          <div class="expert-contact">
            <p><a href="tel:+12045046631">+1 204 504 6631</a></p>
            <p><a href="tel:+12049621286">+1 204 962 1286</a></p>
            <p><a href="mailto:georges.bohemier@century21.ca">admin@mcre.ca</a></p>
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script>
    function printFlyer(propertyId) {
      const flyerFrame = document.getElementById('flyer-frame');
      if (!flyerFrame) {
        console.error('Flyer iframe not found');
        return;
      }
      const flyerUrl = `/flyer/${propertyId}`;
      flyerFrame.src = flyerUrl; // Load the flyer in the iframe
      flyerFrame.onload = () => {
        try {
          flyerFrame.contentWindow.focus();
          flyerFrame.contentWindow.print();
        } catch (e) {
          console.error('Failed to print flyer:', e);
        }
      };
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM fully loaded, initializing carousel...');

      const container = document.querySelector('.carousel-container');
      if (!container) {
        console.error('Carousel container not found');
        return;
      }

      const slides = container.querySelector('.slides');
      if (!slides) {
        console.error('Slides container not found');
        return;
      }

      const slideElements = container.querySelectorAll('.slide');
      if (slideElements.length === 0) {
        console.error('No slides found');
        return;
      }

      const total = slideElements.length;
      console.log(`Found ${total} slides`);

      let currentIndex = 1; // Start at the first real slide (after the duplicated last slide)

      // Set up slides container
      slides.style.display = 'flex';
      slides.style.width = `${100 * total}%`;
      slides.style.transition = 'transform 0.7s ease'; // Match CSS transition
      slideElements.forEach(slide => {
        slide.style.width = `${100 / total}%`;
        slide.style.minWidth = `${100 / total}%`; // Ensure each slide takes exact width
        slide.style.flex = `0 0 ${100 / total}%`;
      });

      function updatePosition() {
        const translateValue = -currentIndex * (100 / total);
        slides.style.transform = `translateX(${translateValue}%)`;
      }

      function show(i, withTransition = true) {
        currentIndex = i;
        if (withTransition) {
          slides.style.transition = 'transform 0.7s ease';
        } else {
          slides.style.transition = 'none';
        }
        updatePosition();
      }

      // Navigation buttons
      const prevButton = container.querySelector('.nav.prev');
      const nextButton = container.querySelector('.nav.next');

      if (!prevButton || !nextButton) {
        console.error('One or both navigation buttons not found');
        return;
      }

      nextButton.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('Next button clicked');
        currentIndex++;
        show(currentIndex);
        if (currentIndex === total - 1) { // Reached duplicated first slide
          setTimeout(() => {
            currentIndex = 1; // Reset to first real slide
            show(currentIndex, false);
          }, 700); // Match transition duration
        }
      });

      prevButton.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('Previous button clicked');
        currentIndex--;
        show(currentIndex);
        if (currentIndex === 0) { // Reached duplicated last slide
          setTimeout(() => {
            currentIndex = total - 2; // Reset to last real slide
            show(currentIndex, false);
          }, 700); // Match transition duration
        }
      });

      // Initialize
      show(currentIndex);
    });
  </script>
</body>
</html>
